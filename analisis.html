<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador Financiero Profesional</title>
    <link rel="stylesheet" href="css/estilo.css">
    <style>
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .input-group input[readonly] {
            background-color: #f5f5f5;
            color: #333;
            border-color: #ccc;
        }
        .input-group textarea {
            height: 150px;
            font-family: monospace;
            font-size: 13px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .btn-success { background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; }
        .btn-deepseek { background: #0d1117; color: white; }
        .btn-gemini { background: #1A73E8; color: white; }
        .btn-chatgpt { background: #10a37f; color: white; }
        .btn-claude { background: #7C3AED; color: white; }
        .btn-advanced { background: #6441A5; color: white; }
        .btn-captura { background: #FF5722; color: white; padding: 15px 25px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 10px 0; width: 100%; }
        .btn-captura-advanced { background: #9C27B0; color: white; padding: 15px 25px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 10px 0; width: 100%; }
        .ia-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin: 15px 0; }
        .resultado { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; max-height: 600px; overflow-y: auto; }
        .info-box { background: #e3f2fd; border-left: 4px solid #2196F3; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .info-box.warning { background: #fff3e0; border-left-color: #FF9800; }
        .info-box.success { background: #e8f5e9; border-left-color: #4CAF50; }
        .badge-success { background: #d4edda; color: #155724; padding: 3px 8px; border-radius: 3px; }
        .badge-warning { background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 3px; }
        .badge-danger { background: #f8d7da; color: #721c24; padding: 3px 8px; border-radius: 3px; }
        .advanced-options {
            background: #f0f0f0;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }
        .tooltip-info {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }
        .seccion-datos {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        .seccion-datos h3 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }
        .asistente-pasos {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #ddd;
        }
        .paso {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        .numero-paso {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .analisis-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            background: #f0f0f0;
        }
        .tab.active {
            background: #667eea;
            color: white;
        }
        .veredicto-box {
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 18px;
            text-align: center;
        }
        .veredicto-comprar { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .veredicto-mantener { background: #fff3cd; color: #856404; border: 2px solid #ffeeba; }
        .veredicto-vender { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .contexto-box {
            background: #f0f7ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .contexto-box h4 {
            color: #004085;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="menu">
            <h1>üîç ANALIZADOR FINANCIERO PROFESIONAL</h1>
            <div class="nav">
                <button style="background: #4CAF50; color: white;" onclick="location.href='dashboard.html'">üè† Dashboard</button>
                <button style="background: #2196F3; color: white;" onclick="location.href='cartera.html'">üìà Cartera Principal</button>
                <button style="background: #FF9800; color: white;" onclick="location.href='rebalanceos.html'">üîÑ Hist√≥rico</button>
                <button style="background: #9C27B0; color: white;" onclick="location.href='analisis.html'">üîç Analizador</button>
                <button style="background: #00BCD4; color: white;" onclick="location.href='composicion.html'">üìä Composici√≥n</button>
                <button style="background: #f44336; color: white;" onclick="location.href='graficos.html'">üìà Gr√°ficos</button>
                <button style="background: #607D8B; color: white;" onclick="location.href='herramientas.html'">üõ†Ô∏è Herramientas</button>
                <button style="background: #ff9800; color: white;" onclick="location.href='ayuda.html'">‚ùì Ayuda</button>
            </div>
        </div>

        <!-- CONTEXTO ACTUAL (informaci√≥n para el usuario) -->
        <div class="contexto-box">
            <h4>üåç CONTEXTO GEOPOL√çTICO Y MACRO ACTUAL (a tener en cuenta en el an√°lisis)</h4>
            <div class="grid-3">
                <div>
                    <strong>üî¥ Conflictos activos:</strong>
                    <ul style="margin-left:20px; font-size:13px;">
                        <li>Ucrania-Rusia (defensa, energ√≠a)</li>
                        <li>Israel-Gaza (petr√≥leo, geopol√≠tica)</li>
                        <li>Tensi√≥n China-Taiw√°n (tecnolog√≠a)</li>
                    </ul>
                </div>
                <div>
                    <strong>üí∞ Ciclo econ√≥mico:</strong>
                    <ul style="margin-left:20px; font-size:13px;">
                        <li>Tipos de inter√©s altos</li>
                        <li>Inflaci√≥n controlada</li>
                        <li>Posible recesi√≥n t√©cnica</li>
                    </ul>
                </div>
                <div>
                    <strong>üìà Sectores beneficiados:</strong>
                    <ul style="margin-left:20px; font-size:13px;">
                        <li>Defensa y armamento</li>
                        <li>Energ√©tico (petr√≥leo, gas)</li>
                        <li>Tecnolog√≠a (IA, ciberseguridad)</li>
                        <li>Materias primas</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ASISTENTE INTERACTIVO -->
        <div class="card">
            <h2>ü§ñ ASISTENTE DE AN√ÅLISIS INTELIGENTE</h2>
            
            <div class="asistente-pasos">
                <div class="paso">
                    <div class="numero-paso">1</div>
                    <div style="flex:1;">
                        <strong>Introduce el ISIN o Ticker</strong>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <input type="text" id="asistenteIsin" placeholder="Ej: US01609W1027 (Alcoa)" style="flex:2;">
                            <select id="asistenteTipo" style="flex:1;">
                                <option value="ACCION">Acci√≥n</option>
                                <option value="FONDO">Fondo</option>
                                <option value="ETF">ETF</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="paso">
                    <div class="numero-paso">2</div>
                    <div style="flex:1;">
                        <strong>Aporta informaci√≥n adicional (opcional)</strong>
                        <p style="color:#666; font-size:13px;">Puedes adjuntar capturas, texto, o cualquier documento relevante</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn-info" onclick="asistente.adjuntarCaptura()">üì∏ Adjuntar captura</button>
                            <button class="btn-info" onclick="asistente.adjuntarTexto()">üìã Adjuntar texto</button>
                            <button class="btn-info" onclick="asistente.adjuntarDocumento()">üìÑ Adjuntar documento</button>
                        </div>
                        <div id="archivosAdjuntos" style="margin-top:10px; font-size:13px; color:#666;"></div>
                    </div>
                </div>
                
                <div class="paso">
                    <div class="numero-paso">3</div>
                    <div style="flex:1;">
                        <strong>Generar prompt y obtener JSON</strong>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn-advanced" onclick="asistente.generarPrompt()">üéØ GENERAR PROMPT COMPLETO</button>
                            <button class="btn-primary" onclick="asistente.ejecutarBusqueda()">üîç EJECUTAR B√öSQUEDA</button>
                        </div>
                        <p style="color:#666; font-size:12px; margin-top:5px;">El prompt incluir√° contexto macro, geopol√≠tico y noticias relevantes</p>
                    </div>
                </div>
                
                <div class="paso">
                    <div class="numero-paso">4</div>
                    <div style="flex:1;">
                        <strong>Pega aqu√≠ el JSON generado</strong>
                        <textarea id="asistenteJson" rows="6" style="width:100%; font-family:monospace; padding:10px; margin:10px 0;" placeholder='Pega el JSON que te devuelva la IA...'></textarea>
                        <button class="btn-success" onclick="asistente.procesarJSON()">üì• PROCESAR JSON Y VEREDICTO</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid-2">
            <!-- Columna izquierda: Datos de entrada detallados -->
            <div class="card">
                <h2>üìä DATOS DETALLADOS DEL ACTIVO</h2>
                
                <div class="analisis-tabs">
                    <div class="tab active" onclick="cambiarTipoAnalisis('accion')">üìà Acci√≥n</div>
                    <div class="tab" onclick="cambiarTipoAnalisis('fondo')">üè¶ Fondo</div>
                    <div class="tab" onclick="cambiarTipoAnalisis('etf')">üìä ETF</div>
                </div>
                
                <!-- SECCI√ìN ACCIONES -->
                <div id="seccionAccion" class="seccion-datos">
                    <h3>üìà Datos de Acci√≥n</h3>
                    
                    <div class="grid-2">
                        <div class="input-group"><label>Ticker:</label><input type="text" id="accionTicker" readonly></div>
                        <div class="input-group"><label>ISIN:</label><input type="text" id="accionIsin" readonly></div>
                    </div>
                    
                    <h4>Precio y Valoraci√≥n</h4>
                    <div class="grid-3">
                        <div class="input-group"><label>Precio (‚Ç¨):</label><input type="number" id="accionPrecio" step="0.01" readonly></div>
                        <div class="input-group"><label>Capitalizaci√≥n (M‚Ç¨):</label><input type="number" id="accionCap" step="0.01" readonly></div>
                        <div class="input-group"><label>Volumen medio:</label><input type="number" id="accionVolumen" readonly></div>
                    </div>
                    
                    <h4>Ratios de Valoraci√≥n</h4>
                    <div class="grid-4">
                        <div class="input-group"><label>PER:</label><input type="number" id="accionPer" step="0.01" readonly></div>
                        <div class="input-group"><label>PEG:</label><input type="number" id="accionPeg" step="0.01" readonly></div>
                        <div class="input-group"><label>P/VC:</label><input type="number" id="accionPvc" step="0.01" readonly></div>
                        <div class="input-group"><label>P/Ventas:</label><input type="number" id="accionPVentas" step="0.01" readonly></div>
                        <div class="input-group"><label>P/FCF:</label><input type="number" id="accionPFcf" step="0.01" readonly></div>
                        <div class="input-group"><label>EV/EBITDA:</label><input type="number" id="accionEvEbitda" step="0.01" readonly></div>
                    </div>
                    
                    <h4>Rentabilidad y Crecimiento</h4>
                    <div class="grid-3">
                        <div class="input-group"><label>BPA (‚Ç¨):</label><input type="number" id="accionBpa" step="0.01" readonly></div>
                        <div class="input-group"><label>Dividendo (‚Ç¨):</label><input type="number" id="accionDividendo" step="0.01" readonly></div>
                        <div class="input-group"><label>Rentabilidad div (%):</label><input type="number" id="accionRentDiv" step="0.01" readonly></div>
                        <div class="input-group"><label>Pay-out ratio (%):</label><input type="number" id="accionPayout" step="0.01" readonly></div>
                        <div class="input-group"><label>Crecimiento BPA (5y):</label><input type="number" id="accionCrecBpa" step="0.01" readonly></div>
                    </div>
                    
                    <h4>Ratios de Rentabilidad</h4>
                    <div class="grid-3">
                        <div class="input-group"><label>ROE (%):</label><input type="number" id="accionRoe" step="0.01" readonly></div>
                        <div class="input-group"><label>ROCE (%):</label><input type="number" id="accionRoce" step="0.01" readonly></div>
                        <div class="input-group"><label>Margen neto (%):</label><input type="number" id="accionMargen" step="0.01" readonly></div>
                    </div>
                    
                    <h4>Riesgo y Volatilidad</h4>
                    <div class="grid-3">
                        <div class="input-group"><label>Beta:</label><input type="number" id="accionBeta" step="0.01" readonly></div>
                        <div class="input-group"><label>Volatilidad (%):</label><input type="number" id="accionVolatilidad" step="0.01" readonly></div>
                        <div class="input-group"><label>Sharpe ratio:</label><input type="number" id="accionSharpe" step="0.01" readonly></div>
                    </div>
                    
                    <h4>Balance</h4>
                    <div class="grid-3">
                        <div class="input-group"><label>Valor contable (‚Ç¨):</label><input type="number" id="accionVc" step="0.01" readonly></div>
                        <div class="input-group"><label>Deuda/EBITDA:</label><input type="number" id="accionDeudaEbitda" step="0.01" readonly></div>
                        <div class="input-group"><label>Liquidez:</label><input type="number" id="accionLiquidez" step="0.01" readonly></div>
                    </div>
                    
                    <h4>M√°ximos y M√≠nimos</h4>
                    <div class="grid-3">
                        <div class="input-group"><label>M√°x 52 sem:</label><input type="number" id="accionMax52" step="0.01" readonly></div>
                        <div class="input-group"><label>M√≠n 52 sem:</label><input type="number" id="accionMin52" step="0.01" readonly></div>
                        <div class="input-group"><label>Media 50d:</label><input type="number" id="accionMedia50" step="0.01" readonly></div>
                        <div class="input-group"><label>Media 200d:</label><input type="number" id="accionMedia200" step="0.01" readonly></div>
                    </div>
                    
                    <h4>Accionariado</h4>
                    <div class="grid-2">
                        <div class="input-group"><label>% Insiders:</label><input type="number" id="accionInsiders" step="0.01" readonly></div>
                        <div class="input-group"><label>% Instituciones:</label><input type="number" id="accionInstituciones" step="0.01" readonly></div>
                    </div>
                </div>
                
                <!-- SECCI√ìN FONDOS -->
                <div id="seccionFondo" class="seccion-datos" style="display: none;">
                    <h3>üè¶ Datos de Fondo</h3>
                    
                    <div class="grid-2">
                        <div class="input-group"><label>ISIN:</label><input type="text" id="fondoIsin" readonly></div>
                        <div class="input-group"><label>Nombre:</label><input type="text" id="fondoNombre" readonly></div>
                    </div>
                    
                    <h4>Datos Generales</h4>
                    <div class="grid-3">
                        <div class="input-group"><label>Patrimonio (M‚Ç¨):</label><input type="number" id="fondoPatrimonio" step="0.01" readonly></div>
                        <div class="input-group"><label>VL (‚Ç¨):</label><input type="number" id="fondoVl" step="0.01" readonly></div>
                        <div class="input-group"><label>N¬∫ part√≠cipes:</label><input type="number" id="fondoParticipes" readonly></div>
                    </div>
                    
                    <h4>Comisiones</h4>
                    <div class="grid-3">
                        <div class="input-group"><label>TER (%):</label><input type="number" id="fondoTer" step="0.01" readonly></div>
                        <div class="input-group"><label>Gesti√≥n (%):</label><input type="number" id="fondoGestion" step="0.01" readonly></div>
                        <div class="input-group"><label>Dep√≥sito (%):</label><input type="number" id="fondoDeposito" step="0.01" readonly></div>
                        <div class="input-group"><label>√âxito (%):</label><input type="number" id="fondoExito" step="0.01" readonly></div>
                    </div>
                    
                    <h4>Rentabilidades</h4>
                    <div class="grid-3">
                        <div class="input-group"><label>YTD (%):</label><input type="number" id="fondoYtd" step="0.01" readonly></div>
                        <div class="input-group"><label>1 a√±o (%):</label><input type="number" id="fondo1a" step="0.01" readonly></div>
                        <div class="input-group"><label>3 a√±os (% anual):</label><input type="number" id="fondo3a" step="0.01" readonly></div>
                        <div class="input-group"><label>5 a√±os (% anual):</label><input type="number" id="fondo5a" step="0.01" readonly></div>
                        <div class="input-group"><label>10 a√±os (% anual):</label><input type="number" id="fondo10a" step="0.01" readonly></div>
                    </div>
                    
                    <h4>Riesgo</h4>
                    <div class="grid-3">
                        <div class="input-group"><label>Volatilidad (%):</label><input type="number" id="fondoVolatilidad" step="0.01" readonly></div>
                        <div class="input-group"><label>Sharpe:</label><input type="number" id="fondoSharpe" step="0.01" readonly></div>
                        <div class="input-group"><label>Alpha:</label><input type="number" id="fondoAlpha" step="0.01" readonly></div>
                        <div class="input-group"><label>Beta:</label><input type="number" id="fondoBeta" step="0.01" readonly></div>
                        <div class="input-group"><label>Rating Morningstar:</label><input type="text" id="fondoRating" readonly></div>
                    </div>
                    
                    <h4>Composici√≥n</h4>
                    <div class="grid-2">
                        <div class="input-group"><label>Categor√≠a:</label><input type="text" id="fondoCategoria" readonly></div>
                        <div class="input-group"><label>√çndice referencia:</label><input type="text" id="fondoBenchmark" readonly></div>
                    </div>
                    <div class="input-group"><label>Top 10 posiciones (%):</label><input type="number" id="fondoTop10" step="0.01" readonly></div>
                    <div class="input-group"><label>N¬∫ posiciones:</label><input type="number" id="fondoNposiciones" readonly></div>
                </div>
                
                <!-- SECCI√ìN ETFs -->
                <div id="seccionEtf" class="seccion-datos" style="display: none;">
                    <h3>üìä Datos de ETF</h3>
                    
                    <div class="grid-2">
                        <div class="input-group"><label>Ticker:</label><input type="text" id="etfTicker" readonly></div>
                        <div class="input-group"><label>ISIN:</label><input type="text" id="etfIsin" readonly></div>
                        <div class="input-group"><label>Nombre:</label><input type="text" id="etfNombre" readonly></div>
                        <div class="input-group"><label>Emisor:</label><input type="text" id="etfEmisor" readonly></div>
                    </div>
                    
                    <h4>Datos Generales</h4>
                    <div class="grid-3">
                        <div class="input-group"><label>Patrimonio (M‚Ç¨):</label><input type="number" id="etfPatrimonio" step="0.01" readonly></div>
                        <div class="input-group"><label>Precio (‚Ç¨):</label><input type="number" id="etfPrecio" step="0.01" readonly></div>
                        <div class="input-group"><label>Volumen diario:</label><input type="number" id="etfVolumen" readonly></div>
                    </div>
                    
                    <h4>Comisiones</h4>
                    <div class="grid-2">
                        <div class="input-group"><label>TER (%):</label><input type="number" id="etfTer" step="0.01" readonly></div>
                        <div class="input-group"><label>Tracking difference (%):</label><input type="number" id="etfTrackingDiff" step="0.01" readonly></div>
                    </div>
                    
                    <h4>Rentabilidades</h4>
                    <div class="grid-3">
                        <div class="input-group"><label>YTD (%):</label><input type="number" id="etfYtd" step="0.01" readonly></div>
                        <div class="input-group"><label>1 a√±o (%):</label><input type="number" id="etf1a" step="0.01" readonly></div>
                        <div class="input-group"><label>3 a√±os (% anual):</label><input type="number" id="etf3a" step="0.01" readonly></div>
                        <div class="input-group"><label>5 a√±os (% anual):</label><input type="number" id="etf5a" step="0.01" readonly></div>
                    </div>
                    
                    <h4>Riesgo</h4>
                    <div class="grid-3">
                        <div class="input-group"><label>Volatilidad (%):</label><input type="number" id="etfVolatilidad" step="0.01" readonly></div>
                        <div class="input-group"><label>Sharpe:</label><input type="number" id="etfSharpe" step="0.01" readonly></div>
                        <div class="input-group"><label>Beta:</label><input type="number" id="etfBeta" step="0.01" readonly></div>
                    </div>
                    
                    <h4>Composici√≥n</h4>
                    <div class="grid-2">
                        <div class="input-group"><label>√çndice replicado:</label><input type="text" id="etfIndice" readonly></div>
                        <div class="input-group"><label>Tipo r√©plica:</label><input type="text" id="etfReplica" readonly></div>
                    </div>
                    <div class="input-group"><label>N¬∫ posiciones:</label><input type="number" id="etfNposiciones" readonly></div>
                    <div class="input-group"><label>Dividendo (%):</label><input type="number" id="etfDividendo" step="0.01" readonly></div>
                </div>
            </div>

            <!-- Columna derecha: Resultados y veredicto -->
            <div class="card">
                <h2>üìã RESULTADOS Y VEREDICTO</h2>
                
                <div id="veredictoBox" class="veredicto-box" style="display: none;">
                    <!-- Aqu√≠ se mostrar√° el veredicto -->
                </div>
                
                <div id="resultados" class="resultado">
                    <p style="text-align: center; color: #666;">Introduce el ISIN y usa el asistente para obtener un an√°lisis completo con contexto geopol√≠tico</p>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/ui.js"></script>
    <script>
        // ==============================================
        // ASISTENTE INTERACTIVO CON CONTEXTO GEOPOL√çTICO
        // ==============================================
        const asistente = {
            archivos: [],
            
            adjuntarCaptura: function() {
                this.archivos.push({ tipo: 'captura', nombre: `Captura_${this.archivos.length+1}.png` });
                this.actualizarListaArchivos();
                UI.mostrarAlerta('üì∏ Captura a√±adida a la lista', 'info');
            },
            
            adjuntarTexto: function() {
                let texto = prompt('Pega el texto copiado:');
                if (texto) {
                    this.archivos.push({ tipo: 'texto', contenido: texto, nombre: `Texto_${this.archivos.length+1}.txt` });
                    this.actualizarListaArchivos();
                    UI.mostrarAlerta('üìã Texto a√±adido a la lista', 'info');
                }
            },
            
            adjuntarDocumento: function() {
                this.archivos.push({ tipo: 'documento', nombre: `Documento_${this.archivos.length+1}.pdf` });
                this.actualizarListaArchivos();
                UI.mostrarAlerta('üìÑ Documento a√±adido a la lista', 'info');
            },
            
            actualizarListaArchivos: function() {
                let div = document.getElementById('archivosAdjuntos');
                if (this.archivos.length === 0) {
                    div.innerHTML = '';
                    return;
                }
                let html = '<strong>Archivos adjuntos:</strong><ul>';
                this.archivos.forEach(a => {
                    html += `<li>${a.nombre} (${a.tipo})</li>`;
                });
                html += '</ul>';
                div.innerHTML = html;
            },
            
            generarPrompt: function() {
                let isin = document.getElementById('asistenteIsin').value.trim();
                let tipo = document.getElementById('asistenteTipo').value;
                
                if (!isin) {
                    UI.mostrarAlerta('Por favor, introduce un ISIN', 'warning');
                    return;
                }
                
                let fechaActual = new Date().toLocaleDateString('es-ES');
                
                let prompt = `üîç **AN√ÅLISIS COMPLETO DE ACTIVO FINANCIERO CON CONTEXTO GLOBAL**
Fecha del an√°lisis: ${fechaActual}

## üìå DATOS DEL ACTIVO
- ISIN: ${isin}
- Tipo: ${tipo}

## üèõÔ∏è 1. CONTEXTO MACROECON√ìMICO Y GEOPOL√çTICO ACTUAL

### 1.1 CICLO ECON√ìMICO
- **Fase del ciclo**: ¬øExpansi√≥n, pico, recesi√≥n o recuperaci√≥n?
- **Pol√≠tica monetaria**: ¬øTipos altos/bajos? ¬øPr√≥ximos movimientos de la FED/BCE?
- **Inflaci√≥n**: ¬øControlada o repunte? ¬øC√≥mo afecta al sector?
- **Empleo**: ¬øMercado laboral fuerte o d√©bil?
- **Confianza del consumidor**: ¬øOptimismo o pesimismo?

### 1.2 CONTEXTO GEOPOL√çTICO
- **Conflictos activos**:
  - Ucrania-Rusia: impacto en energ√≠a, defensa, materias primas
  - Israel-Gaza: tensi√≥n en Oriente Medio, petr√≥leo
  - China-Taiw√°n: tensi√≥n tecnol√≥gica y comercial
- **Sanciones y guerras comerciales**: ¬øAfectan a la cadena de suministro?
- **Elecciones y cambios pol√≠ticos**: ¬øPosibles cambios regulatorios?
- **Estabilidad regional**: ¬øRiesgo pa√≠s, corrupci√≥n, cambios de gobierno?

### 1.3 SECTORES BENEFICIADOS/PERJUDICADOS EN EL CONTEXTO ACTUAL
- **Defensa y armamento**: + por conflictos b√©licos
- **Energ√≠a tradicional**: + por crisis energ√©tica
- **Energ√≠as renovables**: + por transici√≥n ecol√≥gica
- **Tecnolog√≠a**: + por IA, digitalizaci√≥n, ciberseguridad
- **Farmac√©utico**: + por envejecimiento poblaci√≥n, pandemias
- **Inmobiliario**: - por tipos altos
- **Consumo discrecional**: - por inflaci√≥n
- **Materias primas**: + por inflaci√≥n y conflictos

### 1.4 NOTICIAS RELEVANTES (√öLTIMOS 6 MESES)
- **Resultados empresariales**: ¬øSorprendieron al alza/baja? ¬øRevisiones de guidance?
- **Fusiones y adquisiciones**: ¬øRumores o confirmaciones?
- **Contratos importantes**: ¬øNuevos clientes o mercados?
- **Lanzamientos de productos**: ¬øInnovaci√≥n disruptiva?
- **Cambios en la direcci√≥n**: ¬øNuevo CEO con nueva estrategia?
- **Problemas legales**: ¬øDemandas, investigaciones, multas?
- **Dividendos**: ¬øAumento, recorte o suspensi√≥n?
- **Split/contra-split**: ¬øMovimientos corporativos?
- **OPAs**: ¬øPosible compra de la compa√±√≠a?

### 1.5 GRANDES INVERSORES
- **Instituciones**: BlackRock, Vanguard, State Street ¬øaumentan o reducen?
- **Insiders**: Directivos y consejeros ¬øcompran o venden?
- **Inversores activistas**: ¬øHan entrado fondos como Elliott, Third Point?
- **Gur√∫s**: ¬øWarren Buffett, Cathie Wood, Ray Dalio tienen posici√≥n?
- **Cambios significativos**: ¬øAlg√∫n inversor relevante ha entrado/salido?

## üìà 2. AN√ÅLISIS T√âCNICO Y DE MOMENTUM

- **Tendencia**: ¬øAlcista, bajista o lateral en 1d, 1s, 1m, 3m, 1a?
- **Soportes y resistencias**: Niveles clave
- **Medias m√≥viles**: ¬øPrecio > MA50? ¬øMA50 > MA200? (Golden/Death cross)
- **RSI**: ¬øSobrecompra (>70) o sobreventa (<30)?
- **MACD**: ¬øSe√±al de compra o venta?
- **Volumen**: ¬øConfirma la tendencia? ¬øVolumen inusual?
- **Patrones de velas**: ¬øFormaciones relevantes?
- **Figuras chartistas**: ¬øHCH, doble suelo, cu√±a, bandera?

## üìä 3. AN√ÅLISIS FUNDAMENTAL COMPLETO

### 3.1 VALORACI√ìN
- **PER**: ¬øAlto/bajo vs media hist√≥rica y sector?
- **PEG**: ¬øCaro/barato considerando crecimiento?
- **P/VC**: ¬øSobre o infravalorado?
- **EV/EBITDA**: ¬øAtractivo para adquisiciones?
- **P/FCF**: ¬øGenera caja suficiente?

### 3.2 CRECIMIENTO
- **BPA**: ¬øCrecimiento √∫ltimo a√±o, 3 a√±os, 5 a√±os?
- **Ventas**: ¬øAceleraci√≥n o desaceleraci√≥n?
- **FCF**: ¬øMejora o empeora?

### 3.3 RENTABILIDAD
- **ROE, ROCE**: ¬øCreando valor?
- **M√°rgenes**: ¬øExpansi√≥n o contracci√≥n?
- **Tendencias**: ¬øMejorando o empeorando?

### 3.4 SALUD FINANCIERA
- **Deuda/EBITDA**: ¬øNivel saludable?
- **Liquidez**: ¬øProblemas de solvencia?
- **Cobertura de intereses**: ¬øCapacidad de pago?

## üéØ 4. AN√ÅLISIS DE RIESGOS Y OPORTUNIDADES

### 4.1 RIESGOS ESPEC√çFICOS
- **Dependencia de clientes**: ¬øConcentraci√≥n?
- **Dependencia de proveedores**: ¬øCadena de suministro fr√°gil?
- **Regulaci√≥n**: ¬øSector regulado? ¬øCambios normativos?
- **Competencia**: ¬øVentajas competitivas (moat)?
- **Disrupci√≥n tecnol√≥gica**: ¬øRiesgo de quedarse atr√°s?

### 4.2 RIESGOS MACRO
- **Sensibilidad a tipos**: ¬øMucha deuda? ¬øSector c√≠clico?
- **Sensibilidad a divisas**: ¬øExposici√≥n internacional?
- **Sensibilidad a materias primas**: ¬øCostes afectados?

### 4.3 OPORTUNIDADES
- **Nuevos mercados**: ¬øExpansi√≥n internacional?
- **Nuevos productos**: ¬øPipeline de innovaci√≥n?
- **Eficiencias**: ¬øMejora de m√°rgenes?
- **M&A**: ¬øPosibles adquisiciones?

## üìÖ 5. CATALIZADORES PR√ìXIMOS (PR√ìXIMOS 3-6 MESES)

- **Fecha de resultados**: ¬øExpectativas?
- **Eventos del sector**: ¬øConferencias, ferias?
- **Decisiones regulatorias**: ¬øAprobaciones pendientes?
- **Lanzamientos**: ¬øNuevos productos/servicios?
- **Vencimiento de patentes**: ¬øRiesgo de gen√©ricos?
- **Pago de dividendos**: ¬øFecha y cantidad?
- **Split**: ¬øPosible?

## üîÆ 6. ESCENARIOS PROBABLES

### 6.1 ESCENARIO ALCISTA (+20%)
- **¬øQu√© tendr√≠a que pasar?**
- **Probabilidad estimada**: Alta/Media/Baja
- **Precio objetivo alcista**: 

### 6.2 ESCENARIO NEUTRAL (0% a +10%)
- **¬øQu√© tendr√≠a que pasar?**
- **Probabilidad estimada**: 
- **Rango de precio**:

### 6.3 ESCENARIO BAJISTA (-20%)
- **¬øQu√© tendr√≠a que pasar?**
- **Probabilidad estimada**: 
- **Precio objetivo bajista**: 
- **Stop loss recomendado**:

## ‚úÖ 7. RECOMENDACI√ìN FINAL

### 7.1 VEREDICTO
- **¬øCOMPRAR, MANTENER o VENDER?**
- **Horizonte recomendado**: Corto/Medio/Largo plazo

### 7.2 ESTRATEGIA DE ENTRADA
- **Compra √∫nica**: ¬øAhora o esperar?
- **DCA**: ¬øCu√°nto y cada cu√°nto?
- **Precio de entrada ideal**: 

### 7.3 ESTRATEGIA DE SALIDA
- **Take profit**: ¬øA qu√© precio?
- **Stop loss**: ¬øD√≥nde?
- **Trailing stop**: ¬øRecomendado?

### 7.4 FUNDAMENTO DE LA RECOMENDACI√ìN
(Explicaci√≥n breve pero contundente de por qu√©)

## üìã ESTRUCTURA DEL JSON REQUERIDO

### Para ACCIONES:
{
  "tipo": "ACCION",
  "datos_basicos": {
    "nombre": "",
    "ticker": "",
    "isin": "${isin}",
    "precio": 0,
    "capitalizacion": 0,
    "volumen_medio": 0
  },
  "ratios_valoracion": {
    "per": 0,
    "peg": 0,
    "pvc": 0,
    "p_ventas": 0,
    "p_fcf": 0,
    "ev_ebitda": 0
  },
  "rentabilidad": {
    "bpa": 0,
    "dividendo": 0,
    "rentabilidad_div": 0,
    "payout": 0,
    "crecimiento_bpa_5y": 0
  },
  "ratios_rentabilidad": {
    "roe": 0,
    "roce": 0,
    "margen_neto": 0
  },
  "riesgo": {
    "beta": 0,
    "volatilidad": 0,
    "sharpe": 0
  },
  "balance": {
    "valor_contable": 0,
    "deuda_ebitda": 0,
    "liquidez": 0
  },
  "mercado": {
    "max_52_semanas": 0,
    "min_52_semanas": 0,
    "media_50": 0,
    "media_200": 0
  },
  "accionariado": {
    "insiders": 0,
    "instituciones": 0
  },
  "contexto": {
    "sector_beneficiado": "si/no/neutral",
    "conflictos_afectan": "si/no/neutral",
    "inversores_destacados": ""
  },
  "recomendacion": {
    "veredicto": "COMPRAR/MANTENER/VENDER",
    "precio_objetivo": 0,
    "stop_loss": 0,
    "fundamento": ""
  }
}

### Para FONDOS y ETFs (estructura similar con sus campos espec√≠ficos)...

## üì∏ INFORMACI√ìN ADICIONAL APORTADA POR EL USUARIO:`;

                // A√±adir informaci√≥n de archivos adjuntos
                if (this.archivos.length > 0) {
                    prompt += `\n\nEl usuario ha adjuntado los siguientes elementos:`;
                    this.archivos.forEach(a => {
                        if (a.tipo === 'texto') {
                            prompt += `\n\n--- TEXTO ADJUNTO: ${a.nombre} ---\n${a.contenido}\n--- FIN TEXTO ---`;
                        } else {
                            prompt += `\n- ${a.nombre} (${a.tipo}) - Revisar contenido adjunto`;
                        }
                    });
                } else {
                    prompt += `\n\nNo se ha adjuntado informaci√≥n adicional.`;
                }
                
                prompt += `\n\n## ‚ö†Ô∏è INSTRUCCIONES FINALES:
1. Utiliza TODA la informaci√≥n disponible (incluyendo capturas y textos adjuntos)
2. Complementa con tu conocimiento actualizado del contexto macro y geopol√≠tico
3. S√© espec√≠fico en porcentajes, niveles de precios y fechas
4. El JSON debe ser v√°lido y completo
5. Devu√©lveme SOLO el JSON, sin texto adicional antes o despu√©s
6. Si faltan datos esenciales, ind√≠calo con valores null pero mant√©n la estructura`;
                
                UI.copiarTexto(prompt, '‚úÖ Prompt completo con contexto global copiado');
                window.open('https://chat.deepseek.com', '_blank');
                UI.mostrarAlerta('üåç Prompt con contexto geopol√≠tico copiado. Pega en DeepSeek.', 'info');
            },
            
            ejecutarBusqueda: function() {
                this.generarPrompt();
            },
            
            procesarJSON: function() {
                let texto = document.getElementById('asistenteJson').value.trim();
                if (!texto) {
                    UI.mostrarAlerta('No hay JSON para procesar', 'warning');
                    return;
                }
                
                try {
                    let datos = JSON.parse(texto);
                    
                    // Mostrar veredicto
                    this.mostrarVeredicto(datos);
                    
                    // Rellenar campos seg√∫n tipo
                    if (datos.tipo === 'ACCION') {
                        this.rellenarAccion(datos);
                        cambiarTipoAnalisis('accion');
                    } else if (datos.tipo === 'FONDO') {
                        this.rellenarFondo(datos);
                        cambiarTipoAnalisis('fondo');
                    } else if (datos.tipo === 'ETF') {
                        this.rellenarEtf(datos);
                        cambiarTipoAnalisis('etf');
                    }
                    
                    UI.mostrarAlerta('‚úÖ JSON procesado correctamente', 'info');
                    
                } catch (e) {
                    UI.mostrarAlerta('Error al parsear JSON: ' + e.message, 'warning');
                    console.error(e);
                }
            },
            
            mostrarVeredicto: function(datos) {
                let box = document.getElementById('veredictoBox');
                let veredicto = '';
                let clase = '';
                let precioObjetivo = '';
                let stopLoss = '';
                let fundamento = '';
                
                if (datos.recomendacion) {
                    veredicto = datos.recomendacion.veredicto || 'N/A';
                    if (veredicto.includes('COMPRAR')) clase = 'veredicto-comprar';
                    else if (veredicto.includes('VENDER')) clase = 'veredicto-vender';
                    else clase = 'veredicto-mantener';
                    
                    precioObjetivo = datos.recomendacion.precio_objetivo ? 
                        `<p><strong>Precio objetivo:</strong> ${datos.recomendacion.precio_objetivo.toFixed(2)} ‚Ç¨</p>` : '';
                    stopLoss = datos.recomendacion.stop_loss ? 
                        `<p><strong>Stop loss:</strong> ${datos.recomendacion.stop_loss.toFixed(2)} ‚Ç¨</p>` : '';
                    fundamento = datos.recomendacion.fundamento || '';
                }
                
                box.innerHTML = `
                    <h3>üéØ VEREDICTO: ${veredicto}</h3>
                    ${precioObjetivo}
                    ${stopLoss}
                    <p style="margin-top:10px;">${fundamento}</p>
                `;
                box.className = `veredicto-box ${clase}`;
                box.style.display = 'block';
            },
            
            rellenarAccion: function(d) {
                if (d.datos_basicos) {
                    document.getElementById('accionTicker').value = d.datos_basicos.ticker || '';
                    document.getElementById('accionIsin').value = d.datos_basicos.isin || '';
                    document.getElementById('accionPrecio').value = d.datos_basicos.precio || 0;
                    document.getElementById('accionCap').value = d.datos_basicos.capitalizacion || 0;
                    document.getElementById('accionVolumen').value = d.datos_basicos.volumen_medio || 0;
                }
                
                if (d.ratios_valoracion) {
                    document.getElementById('accionPer').value = d.ratios_valoracion.per || 0;
                    document.getElementById('accionPeg').value = d.ratios_valoracion.peg || 0;
                    document.getElementById('accionPvc').value = d.ratios_valoracion.pvc || 0;
                    document.getElementById('accionPVentas').value = d.ratios_valoracion.p_ventas || 0;
                    document.getElementById('accionPFcf').value = d.ratios_valoracion.p_fcf || 0;
                    document.getElementById('accionEvEbitda').value = d.ratios_valoracion.ev_ebitda || 0;
                }
                
                if (d.rentabilidad) {
                    document.getElementById('accionBpa').value = d.rentabilidad.bpa || 0;
                    document.getElementById('accionDividendo').value = d.rentabilidad.dividendo || 0;
                    document.getElementById('accionRentDiv').value = d.rentabilidad.rentabilidad_div || 0;
                    document.getElementById('accionPayout').value = d.rentabilidad.payout || 0;
                    document.getElementById('accionCrecBpa').value = d.rentabilidad.crecimiento_bpa_5y || 0;
                }
                
                if (d.ratios_rentabilidad) {
                    document.getElementById('accionRoe').value = d.ratios_rentabilidad.roe || 0;
                    document.getElementById('accionRoce').value = d.ratios_rentabilidad.roce || 0;
                    document.getElementById('accionMargen').value = d.ratios_rentabilidad.margen_neto || 0;
                }
                
                if (d.riesgo) {
                    document.getElementById('accionBeta').value = d.riesgo.beta || 0;
                    document.getElementById('accionVolatilidad').value = d.riesgo.volatilidad || 0;
                    document.getElementById('accionSharpe').value = d.riesgo.sharpe || 0;
                }
                
                if (d.balance) {
                    document.getElementById('accionVc').value = d.balance.valor_contable || 0;
                    document.getElementById('accionDeudaEbitda').value = d.balance.deuda_ebitda || 0;
                    document.getElementById('accionLiquidez').value = d.balance.liquidez || 0;
                }
                
                if (d.mercado) {
                    document.getElementById('accionMax52').value = d.mercado.max_52_semanas || 0;
                    document.getElementById('accionMin52').value = d.mercado.min_52_semanas || 0;
                    document.getElementById('accionMedia50').value = d.mercado.media_50 || 0;
                    document.getElementById('accionMedia200').value = d.mercado.media_200 || 0;
                }
                
                if (d.accionariado) {
                    document.getElementById('accionInsiders').value = d.accionariado.insiders || 0;
                    document.getElementById('accionInstituciones').value = d.accionariado.instituciones || 0;
                }
            },
            
            rellenarFondo: function(d) {
                if (d.datos_basicos) {
                    document.getElementById('fondoIsin').value = d.datos_basicos.isin || '';
                    document.getElementById('fondoNombre').value = d.datos_basicos.nombre || '';
                    document.getElementById('fondoPatrimonio').value = d.datos_basicos.patrimonio || 0;
                    document.getElementById('fondoVl').value = d.datos_basicos.vl || 0;
                    document.getElementById('fondoParticipes').value = d.datos_basicos.participes || 0;
                }
                
                if (d.comisiones) {
                    document.getElementById('fondoTer').value = d.comisiones.ter || 0;
                    document.getElementById('fondoGestion').value = d.comisiones.gestion || 0;
                    document.getElementById('fondoDeposito').value = d.comisiones.deposito || 0;
                    document.getElementById('fondoExito').value = d.comisiones.exito || 0;
                }
                
                if (d.rentabilidades) {
                    document.getElementById('fondoYtd').value = d.rentabilidades.ytd || 0;
                    document.getElementById('fondo1a').value = d.rentabilidades.uno_a || 0;
                    document.getElementById('fondo3a').value = d.rentabilidades.tres_a || 0;
                    document.getElementById('fondo5a').value = d.rentabilidades.cinco_a || 0;
                    document.getElementById('fondo10a').value = d.rentabilidades.diez_a || 0;
                }
                
                if (d.riesgo) {
                    document.getElementById('fondoVolatilidad').value = d.riesgo.volatilidad || 0;
                    document.getElementById('fondoSharpe').value = d.riesgo.sharpe || 0;
                    document.getElementById('fondoAlpha').value = d.riesgo.alpha || 0;
                    document.getElementById('fondoBeta').value = d.riesgo.beta || 0;
                    document.getElementById('fondoRating').value = d.riesgo.rating || '';
                }
                
                if (d.composicion) {
                    document.getElementById('fondoCategoria').value = d.composicion.categoria || '';
                    document.getElementById('fondoBenchmark').value = d.composicion.benchmark || '';
                    document.getElementById('fondoTop10').value = d.composicion.top10 || 0;
                    document.getElementById('fondoNposiciones').value = d.composicion.n_posiciones || 0;
                }
            },
            
            rellenarEtf: function(d) {
                if (d.datos_basicos) {
                    document.getElementById('etfTicker').value = d.datos_basicos.ticker || '';
                    document.getElementById('etfIsin').value = d.datos_basicos.isin || '';
                    document.getElementById('etfNombre').value = d.datos_basicos.nombre || '';
                    document.getElementById('etfEmisor').value = d.datos_basicos.emisor || '';
                    document.getElementById('etfPatrimonio').value = d.datos_basicos.patrimonio || 0;
                    document.getElementById('etfPrecio').value = d.datos_basicos.precio || 0;
                    document.getElementById('etfVolumen').value = d.datos_basicos.volumen || 0;
                }
                
                if (d.comisiones) {
                    document.getElementById('etfTer').value = d.comisiones.ter || 0;
                    document.getElementById('etfTrackingDiff').value = d.comisiones.tracking_diff || 0;
                }
                
                if (d.rentabilidades) {
                    document.getElementById('etfYtd').value = d.rentabilidades.ytd || 0;
                    document.getElementById('etf1a').value = d.rentabilidades.uno_a || 0;
                    document.getElementById('etf3a').value = d.rentabilidades.tres_a || 0;
                    document.getElementById('etf5a').value = d.rentabilidades.cinco_a || 0;
                }
                
                if (d.riesgo) {
                    document.getElementById('etfVolatilidad').value = d.riesgo.volatilidad || 0;
                    document.getElementById('etfSharpe').value = d.riesgo.sharpe || 0;
                    document.getElementById('etfBeta').value = d.riesgo.beta || 0;
                }
                
                if (d.composicion) {
                    document.getElementById('etfIndice').value = d.composicion.indice || '';
                    document.getElementById('etfReplica').value = d.composicion.replica || '';
                    document.getElementById('etfNposiciones').value = d.composicion.n_posiciones || 0;
                    document.getElementById('etfDividendo').value = d.composicion.dividendo || 0;
                }
            }
        };

        // ==============================================
        // FUNCIONES DE INTERFAZ
        // ==============================================
        function cambiarTipoAnalisis(tipo) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('seccionAccion').style.display = 'none';
            document.getElementById('seccionFondo').style.display = 'none';
            document.getElementById('seccionEtf').style.display = 'none';
            
            if (tipo === 'accion') document.getElementById('seccionAccion').style.display = 'block';
            else if (tipo === 'fondo') document.getElementById('seccionFondo').style.display = 'block';
            else if (tipo === 'etf') document.getElementById('seccionEtf').style.display = 'block';
        }

        // Inicializar tema
        document.addEventListener('DOMContentLoaded', function() {
            let tema = localStorage.getItem('tema') || 'claro';
            UI.aplicarTema(tema);
        });
    </script>
</body>
</html>