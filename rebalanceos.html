<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hist√≥rico de Rebalanceos</title>
    <link rel="stylesheet" href="css/estilo.css">
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card h4 { 
            font-size: 16px; 
            opacity: 0.9; 
            margin-bottom: 10px; 
        }
        .stat-card p { 
            font-size: 24px; 
            font-weight: bold; 
        }
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="menu">
            <h1>üîÑ HIST√ìRICO DE REBALANCEOS</h1>
            <div class="nav">
                <button style="background: #4CAF50; color: white;" onclick="location.href='dashboard.html'">üè† Dashboard</button>
                <button style="background: #2196F3; color: white;" onclick="location.href='cartera.html'">üìà Cartera Principal</button>
                <button style="background: #FF9800; color: white;" onclick="location.href='rebalanceos.html'">üîÑ Hist√≥rico</button>
                <button style="background: #9C27B0; color: white;" onclick="location.href='analisis.html'">üîç Analizador</button>
                <button style="background: #00BCD4; color: white;" onclick="location.href='composicion.html'">üìä Composici√≥n</button>
                <button style="background: #f44336; color: white;" onclick="location.href='graficos.html'">üìà Gr√°ficos</button>
                <button style="background: #607D8B; color: white;" onclick="location.href='herramientas.html'">üõ†Ô∏è Herramientas</button>
                <button style="background: #ff9800; color: white;" onclick="location.href='ayuda.html'">‚ùì Ayuda</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h4>Total Rebalanceos</h4>
                <p id="totalRegistros">0</p>
            </div>
            <div class="stat-card">
                <h4>Mejor Ganancia</h4>
                <p id="mejorGanancia">0 ‚Ç¨</p>
            </div>
            <div class="stat-card">
                <h4>Peor P√©rdida</h4>
                <p id="peorPerdida">0 ‚Ç¨</p>
            </div>
            <div class="stat-card">
                <h4>Rendimiento Promedio</h4>
                <p id="rendimientoMedio">0%</p>
            </div>
        </div>

        <div class="card">
            <h2>üìã REGISTRO HIST√ìRICO</h2>
            <div class="button-group">
                <button class="btn-primary" onclick="exportarCSV()">üì• Exportar CSV</button>
                <button class="btn-warning" onclick="limpiarHistorico()">üóëÔ∏è Limpiar Hist√≥rico</button>
            </div>
            <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                <table id="tablaHistorico">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Monetario</th>
                            <th>RF Corto</th>
                            <th>RF Medio</th>
                            <th>RV</th>
                            <th>Alternativos</th>
                            <th>ETFs</th>
                            <th>Efectivo</th>
                            <th>Inmobiliario</th>
                            <th>Total</th>
                            <th>Variaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/ui.js"></script>
    <script>
        // ==============================================
        // FUNCIONES DEL HIST√ìRICO
        // ==============================================
        
        function cargarHistorico() {
            let historico = Storage.obtenerHistorico();
            let tbody = document.getElementById('cuerpoTabla');
            
            if (historico.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 50px;">No hay datos hist√≥ricos</td></tr>';
                actualizarEstadisticas([]);
                return;
            }
            
            // Ordenar por timestamp (m√°s reciente primero)
            historico.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            let html = '';
            for (let i = 0; i < historico.length; i++) {
                let item = historico[i];
                let variacion = 0;
                if (i < historico.length - 1) {
                    variacion = item.total - historico[i + 1].total;
                }
                
                let claseVariacion = variacion >= 0 ? 'positivo' : 'negativo';
                let signo = variacion >= 0 ? '+' : '';
                
                // Calcular total de ETFs
                let totalETFs = (item.etfs || []).reduce((s, e) => s + e.cantidad * e.precioActual, 0);
                
                html += `<tr>
                    <td>${item.fecha || '-'}</td>
                    <td>${item.hora || '-'}</td>
                    <td>${(item.monetario || 0).toFixed(2)} ‚Ç¨</td>
                    <td>${(item.rfCorto || 0).toFixed(2)} ‚Ç¨</td>
                    <td>${(item.rfMedio || 0).toFixed(2)} ‚Ç¨</td>
                    <td>${(item.rv || 0).toFixed(2)} ‚Ç¨</td>
                    <td>${(item.alternativos || 0).toFixed(2)} ‚Ç¨</td>
                    <td>${totalETFs.toFixed(2)} ‚Ç¨</td>
                    <td>${(item.efectivo || 0).toFixed(2)} ‚Ç¨</td>
                    <td>${(item.inmobiliario || 0).toFixed(2)} ‚Ç¨</td>
                    <td><strong>${(item.total || 0).toFixed(2)} ‚Ç¨</strong></td>
                    <td class="${claseVariacion}">${signo}${variacion.toFixed(2)} ‚Ç¨</td>
                </tr>`;
            }
            tbody.innerHTML = html;
            actualizarEstadisticas(historico);
        }

        function actualizarEstadisticas(historico) {
            document.getElementById('totalRegistros').innerText = historico.length;
            
            if (historico.length < 2) {
                document.getElementById('mejorGanancia').innerText = '0 ‚Ç¨';
                document.getElementById('peorPerdida').innerText = '0 ‚Ç¨';
                document.getElementById('rendimientoMedio').innerText = '0%';
                return;
            }
            
            let mejorGanancia = -Infinity;
            let peorPerdida = Infinity;
            let sumaRendimiento = 0;
            let count = 0;
            
            for (let i = 0; i < historico.length - 1; i++) {
                let variacion = historico[i].total - historico[i + 1].total;
                if (variacion > mejorGanancia) mejorGanancia = variacion;
                if (variacion < peorPerdida) peorPerdida = variacion;
                
                if (historico[i + 1].total > 0) {
                    sumaRendimiento += (variacion / historico[i + 1].total) * 100;
                    count++;
                }
            }
            
            document.getElementById('mejorGanancia').innerHTML = (mejorGanancia > -Infinity ? mejorGanancia.toFixed(2) : '0') + ' ‚Ç¨';
            document.getElementById('peorPerdida').innerHTML = (peorPerdida < Infinity ? peorPerdida.toFixed(2) : '0') + ' ‚Ç¨';
            document.getElementById('rendimientoMedio').innerHTML = (count > 0 ? (sumaRendimiento / count).toFixed(1) : '0') + '%';
        }

        function exportarCSV() {
            let historico = Storage.obtenerHistorico();
            if (historico.length === 0) {
                UI.mostrarAlerta('No hay datos para exportar', 'warning');
                return;
            }
            
            // Ordenar por timestamp para el CSV (m√°s antiguo primero)
            historico.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
            
            let csv = "Fecha,Hora,Monetario,RF Corto,RF Medio,RV,Alternativos,ETFs,Efectivo,Inmobiliario,Total\n";
            historico.forEach(item => {
                let totalETFs = (item.etfs || []).reduce((s, e) => s + e.cantidad * e.precioActual, 0);
                csv += `${item.fecha},${item.hora},${item.monetario || 0},${item.rfCorto || 0},${item.rfMedio || 0},${item.rv || 0},${item.alternativos || 0},${totalETFs},${item.efectivo || 0},${item.inmobiliario || 0},${item.total || 0}\n`;
            });
            
            let blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' }); // A√±adir BOM para UTF-8
            let link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `historico_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function limpiarHistorico() {
            if (confirm('¬øEst√°s seguro de borrar todo el hist√≥rico? Esto tambi√©n reiniciar√° la cartera al estado inicial.')) {
                Storage.limpiarHistorico();
                
                // Eliminar tambi√©n la marca de cartera configurada y los datos
                localStorage.removeItem('carteraConfigurada');
                localStorage.removeItem('carteraData');
                
                // Limpiar porcentajes a valores por defecto
                localStorage.setItem('pctMonetario', '5');
                localStorage.setItem('pctRFCorto', '15');
                localStorage.setItem('pctRFMedio', '25');
                localStorage.setItem('pctRV', '40');
                localStorage.setItem('pctAlternativos', '15');
                
                cargarHistorico();
                UI.mostrarAlerta('‚úÖ Hist√≥rico limpiado. La cartera est√° en estado inicial.', 'info');
            }
        }

        // Inicializar al cargar la p√°gina
        window.onload = function() {
            cargarHistorico();
            let tema = localStorage.getItem('tema') || 'claro';
            if (typeof UI !== 'undefined' && UI.aplicarTema) {
                UI.aplicarTema(tema);
            } else {
                // Fallback si UI no est√° disponible
                document.body.style.background = tema === 'oscuro' ? '#1a1a1a' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
        };
    </script>
</body>
</html>